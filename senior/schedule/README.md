## 并发和并行

在编程领域，并发（Concurrency）是独立的执行过程 (Process)的组合，而并行（Parallelism)则是计算（可能是相关联的）的同时执行。

并发（Concurrency)是关于同时 应对很多事情(deal with lots of things)

并行（Parallelism)则是同时做许多事情(do lots of things)"

Erlang 之父 Joe Armstrong 的解释，如下图：

![image](http://github.com/altairlee/awesomeGo/blob/master/images/goschedule/%E5%B9%B6%E5%8F%91%E5%B9%B6%E8%A1%8C.jpg?raw=true)

## 线程模型

**N:1**：多个用户线程都运行在一个OS线程上，上下文切换成本低，但是无法利用多核的
**1:1**：一个用户线程对应到一个OS线程，能够利用多核优势，但是上下文切换成本较高，Java Hotspot VM的默认实现方式
**M:N**：结合上边两种方案，实现既可以利用多核，又可以尽量减少上下文切换但成本，但是调度算法实现成本较高

goroutine可以说是用户线程

## 为什么 Go Scheduler 需要实现 M:N 的方案？

**创建线程开销大**

对于OS线程，很多特性都是操作系统给予的，

**降低GC的复杂度**


## 调度器的三个基本对象：
* G (Goroutine)，代表协程，也就是每次代码中使用 go 关键词时候会创建的一个对象
* M (Work Thread)，工作线程
* P (Processor)，代表一个处理器，又称上下文

## G-M-P三者的关系与特点：
1. 每个M必须绑定一个P，线程M创建后会去检查并执行G
2. 每个P都有一个本地G队列，整个调度器还有一个全局的G队列
3. M从队列中提取G并执行
4. P的个数就是GOMAXPROCS（最大256），启动时固定的，一般不修改
5. M的个数和P的个数不一定一样多（会有休眠的M或P不绑定M）（最大10000）
6. P是用一个全局数组（255）来保存的，并且维护着一个全局的P空闲链表

![image](http://github.com/altairlee/awesomeGo/blob/master/images/goschedule/g-m-p.png?raw=true)

## 基本概念
1. 本地队列

每个P维护一个自己的队列，用来保存G，称为本地队列。当与P绑定当M创建新的G时，一般会先放到本地队列，当本地队列满了的时候，会截取本地队列的'一半'放到全局队列

2. 全局队列

全局队列保存着所有本地队列''溢出'的G。为保证公平性，调度过程中，有1/16的概率优先从全局队列中取G，否则本地队列满载的时候，全局队列的G将一直无法被调度到。
所有M共享全局队列，为保证数据竞争问题，需要加锁处理，相对本地队列处理要慢

3. stealing算法

目的是保证空闲的M有活干，不空等，提供资源利用率。规则是空闲的M随机从其他的P本地队列中窃取'一半'的G。

## G任务调度

1. Gorutine从创建到执行
```$xslt
    1. P新建协程G，优先放入本地，如果本地队列满，则放入全局队列
    2. P绑定的M会启动一个底层线程，循环执行能找到的G任务
    3. 首页有1/61的概率从全局队列查找，有60/61的概率从本地队列找查找
    4. 如果在全局队列中找不到G，则从本地队列中找
    5. 如果本地队列中找不到G，则从其他P的本地队列中窃取
    6. 如果其他队列也找不到，则从全局队列中拿一部分到本地队列
    7. 如果再找不到，从网络中poll G
    8. 只要找到了G，则立即丢给M去执行
    9. G的切换时间片为10ms，就是说一个协程最多运行10ms，就会被M切换到下一个G（中断，挂起）
    10. 被中断的任务，会放到本地队列队尾，等待再次执行
    11. 中断时，会将寄存器中的栈信息，保存到G对象中，再次执行是，会将自己保存的栈信息复制到寄存器，接着执行。
```
总结： 调度的本质就是 P 将 G 合理的分配给某个 M 的过程。


## 抢占式调度

在每个方法或者函数的入口，增加一段代码，让runtime有机会检查是否需要执行抢占式调度。这种解决方案，对于没有函数调用G，scheduler依然无法抢占


## 总结
GO并发的设计优势是在于P的加入，如果只有G和M，那么当G阻塞时，M其实是没有在工作的，这就造成了资源浪费。
如果没有P，那么所有的G都会放到全局队列，M取G当时候就会加锁，对多核处理造成很大影响。



